{% extends 'base.html' %}

{% block title %}Review {{ field.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>‚≠ê {% if existing_review %}Update Review{% else %}Add Review{% endif %} - {{ field.name }}</h3>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    {% if field.image %}
                        <img src="{{ field.image.url }}" alt="{{ field.name }}" 
                             style="width: 150px; height: 100px; object-fit: cover; border-radius: 10px;">
                    {% else %}
                        <div style="width: 150px; height: 100px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            üèüÔ∏è
                        </div>
                    {% endif %}
                    <h5 class="mt-2">{{ field.name }}</h5>
                    <p class="text-muted">{{ field.location }}</p>
                </div>

                <form method="post" enctype="multipart/form-data" id="reviewForm">
                    {% csrf_token %}
                    
                    <!-- Rating -->
                    <div class="mb-3">
                        <label for="{{ review_form.rating.id_for_label }}" class="form-label">‚≠ê Rating</label>
                        {{ review_form.rating }}
                        <div id="star-display" class="mt-2"></div>
                    </div>

                    <!-- Experience Title -->
                    <div class="mb-3">
                        <label for="{{ review_form.experience_title.id_for_label }}" class="form-label">üìù Experience Title</label>
                        {{ review_form.experience_title }}
                    </div>

                    <!-- Review Comment -->
                    <div class="mb-3">
                        <label for="{{ review_form.comment.id_for_label }}" class="form-label">üí¨ Your Detailed Review</label>
                        {{ review_form.comment }}
                        <small class="form-text text-muted">Share your experience with other players</small>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="mb-4">
                        <label class="form-label">üì∏ Share Your Experience Photos (Optional)</label>
                        <div class="image-upload-section">
                            <input type="file" 
                                   name="review_images" 
                                   id="review_images" 
                                   class="form-control mb-3" 
                                   accept="image/*" 
                                   multiple 
                                   onchange="previewImages(this)">
                            <small class="form-text text-muted mb-3 d-block">You can upload up to 5 images to share your experience</small>
                            
                            <!-- Image Preview Container -->
                            <div id="image-preview-container" class="mt-3">
                                <div class="row" id="image-previews"></div>
                            </div>

                            <!-- Dynamic Caption Inputs -->
                            <div id="caption-inputs" class="mt-3" style="display: none;">
                                <label class="form-label">üìù Image Captions</label>
                                <div id="caption-fields"></div>
                            </div>

                            <!-- Existing Images (Edit Mode) -->
                            {% if existing_images %}
                                <div class="existing-images mt-3">
                                    <h6>Current Images:</h6>
                                    <div class="row">
                                        {% for image in existing_images %}
                                            <div class="col-md-4 mb-3">
                                                <div class="card">
                                                    <img src="{{ image.image.url }}" class="card-img-top" alt="Review Image" 
                                                         style="height: 150px; object-fit: cover;">
                                                    <div class="card-body p-2">
                                                        <small class="text-muted">{{ image.caption|default:"No caption" }}</small>
                                                        <a href="{% url 'fields:delete_review_image' image.id %}" 
                                                           class="btn btn-danger btn-sm mt-1 w-100"
                                                           onclick="return confirm('Delete this image?')">
                                                            üóëÔ∏è Delete
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if existing_review %}
                                üíæ Update Review
                            {% else %}
                                ‚ú® Submit Review
                            {% endif %}
                        </button>
                        <a href="{% url 'fields:field_detail' field.id %}" class="btn btn-secondary">
                            ‚Üê Back to Field
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratingSelect = document.querySelector('select[name="rating"]');
    const starDisplay = document.getElementById('star-display');
    
    // Update star display when rating changes
    function updateStarDisplay() {
        const rating = parseInt(ratingSelect.value);
        let starsHtml = '';
        
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHtml += '<span class="star filled">‚≠ê</span>';
            } else {
                starsHtml += '<span class="star empty">‚òÜ</span>';
            }
        }
        
        starDisplay.innerHTML = starsHtml;
    }
    
    ratingSelect.addEventListener('change', updateStarDisplay);
    
    // Initial star display
    if (ratingSelect.value) {
        updateStarDisplay();
    }
});

function previewImages(input) {
    const previewContainer = document.getElementById('image-previews');
    const captionInputs = document.getElementById('caption-inputs');
    const captionFields = document.getElementById('caption-fields');
    
    // Clear previous previews and captions
    previewContainer.innerHTML = '';
    captionFields.innerHTML = '';
    
    if (input.files && input.files.length > 0) {
        captionInputs.style.display = 'block';
        
        // Limit to 5 images
        const filesToProcess = Array.from(input.files).slice(0, 5);
        
        filesToProcess.forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create image preview
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-md-4 mb-3';
                    
                    colDiv.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" alt="Preview" 
                                 style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                                <small class="text-muted">Image ${index + 1}</small>
                            </div>
                        </div>
                    `;
                    
                    previewContainer.appendChild(colDiv);
                };
                
                reader.readAsDataURL(file);
                
                // Create caption input
                const captionDiv = document.createElement('div');
                captionDiv.className = 'mb-2';
                captionDiv.innerHTML = `
                    <input type="text" name="image_captions" class="form-control" 
                           placeholder="Caption for Image ${index + 1}..." maxlength="200">
                `;
                captionFields.appendChild(captionDiv);
            }
        });
        
        if (filesToProcess.length > 5) {
            alert('Only the first 5 images will be uploaded.');
        }
    } else {
        captionInputs.style.display = 'none';
    }
}
</script>

<style>
.image-upload-section {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 20px;
    transition: all 0.3s ease;
}

.image-upload-section:hover {
    border-color: #4facfe;
    background-color: #f8f9fc;
}

.star {
    font-size: 1.5rem;
    margin-right: 5px;
}

.star.filled {
    color: #ffd700;
}

.star.empty {
    color: #ddd;
}

#image-preview-container .card {
    transition: all 0.3s ease;
}

#image-preview-container .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.existing-images .card {
    transition: all 0.3s ease;
}

.existing-images .card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}