{% extends 'base.html' %}

{% block title %}Set New Password{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-center">
                <h3>üîí Create New Password</h3>
                <p class="mb-0 text-muted">Almost done! Choose a strong password for your account.</p>
            </div>
            <div class="card-body">
                <!-- Account verification display -->
                <div class="alert alert-success">
                    <h6><strong>‚úÖ Account Verified</strong></h6>
                    <p class="mb-0">We found your account. You can now set a new password.</p>
                </div>

                <form method="post" id="resetForm">
                    {% csrf_token %}
                    
                    <!-- Account info (read-only) -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">üë§ Username</label>
                            {{ form.username }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üìß Email</label>
                            {{ form.email }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- New password fields -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üîê New Password</label>
                                {{ form.new_password }}
                                {% if form.new_password.help_text %}
                                    <small class="form-text text-muted">{{ form.new_password.help_text }}</small>
                                {% endif %}
                                {% if form.new_password.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.new_password.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üîê Confirm Password</label>
                                {{ form.confirm_password }}
                                {% if form.confirm_password.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.confirm_password.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Password strength indicator -->
                    <div class="mb-3">
                        <small class="text-muted">Password strength:</small>
                        <div class="progress" style="height: 5px;">
                            <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="strengthText" class="text-muted"></small>
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Tips for strong password -->
                    <div class="alert alert-light">
                        <small>
                            <strong>üí° Tips for a strong password:</strong><br>
                            ‚Ä¢ Use at least 8 characters<br>
                            ‚Ä¢ Mix uppercase and lowercase letters<br>
                            ‚Ä¢ Include numbers and special characters<br>
                            ‚Ä¢ Avoid common words or personal info
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            ‚úÖ Update Password
                        </button>
                        <a href="{% url 'accounts:cancel_reset' %}" class="btn btn-outline-secondary">
                            ‚ùå Cancel Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.querySelector('input[name="new_password"]');
    const confirmInput = document.querySelector('input[name="confirm_password"]');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const submitBtn = document.getElementById('submitBtn');

    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) strength += 25;
        else feedback.push('at least 8 characters');

        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
        else feedback.push('mixed case letters');

        if (/\d/.test(password)) strength += 25;
        else feedback.push('numbers');

        if (/[^A-Za-z0-9]/.test(password)) strength += 25;
        else feedback.push('special characters');

        return { strength, feedback };
    }

    function updateStrengthIndicator() {
        const password = passwordInput.value;
        const { strength, feedback } = checkPasswordStrength(password);
        
        strengthBar.style.width = strength + '%';
        
        if (strength < 50) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak - Add: ' + feedback.join(', ');
            strengthText.className = 'text-danger';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Good - Consider adding: ' + feedback.join(', ');
            strengthText.className = 'text-warning';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong password!';
            strengthText.className = 'text-success';
        }
    }

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (confirm && password !== confirm) {
            confirmInput.setCustomValidity('Passwords do not match');
            confirmInput.classList.add('is-invalid');
        } else {
            confirmInput.setCustomValidity('');
            confirmInput.classList.remove('is-invalid');
            if (confirm) confirmInput.classList.add('is-valid');
        }
    }

    passwordInput.addEventListener('input', function() {
        updateStrengthIndicator();
        if (confirmInput.value) checkPasswordMatch();
    });

    confirmInput.addEventListener('input', checkPasswordMatch);

    // Form submission validation
    document.getElementById('resetForm').addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (password.length < 6) {
            e.preventDefault();
            alert('Password must be at least 6 characters long.');
            return;
        }
        
        if (password !== confirm) {
            e.preventDefault();
            alert('Passwords do not match.');
            return;
        }
    });
});
</script>
{% endblock %}